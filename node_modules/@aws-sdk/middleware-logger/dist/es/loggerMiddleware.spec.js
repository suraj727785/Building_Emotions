import { __assign, __awaiter, __generator } from "tslib";
import { getLoggerPlugin, loggerMiddleware, loggerMiddlewareOptions } from "./loggerMiddleware";
describe("getLoggerPlugin", function () {
    var mockClientStack = {
        add: jest.fn(),
    };
    afterEach(function () {
        jest.clearAllMocks();
    });
    it("adds loggerMiddleware", function () {
        getLoggerPlugin({}).applyToStack(mockClientStack);
        expect(mockClientStack.add).toHaveBeenCalledTimes(1);
        expect(mockClientStack.add.mock.calls[0][1]).toEqual(loggerMiddlewareOptions);
    });
});
describe("loggerMiddleware", function () {
    var mockNext = jest.fn();
    var mockArgs = {
        input: {
            inputKey: "inputValue",
        },
        request: {
            method: "GET",
            headers: {},
        },
    };
    var mockResponse = {
        response: {
            statusCode: 200,
            headers: {
                "x-amzn-requestid": "requestId",
                "x-amz-id-2": "extendedRequestId",
                "x-amz-cf-id": "cfId",
            },
        },
        output: {
            outputKey: "outputValue",
        },
    };
    afterEach(function () {
        jest.clearAllMocks();
    });
    it("returns without logging if context.logger is not defined", function () { return __awaiter(void 0, void 0, void 0, function () {
        var response;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    mockNext.mockResolvedValueOnce(mockResponse);
                    return [4 /*yield*/, loggerMiddleware()(mockNext, {})(mockArgs)];
                case 1:
                    response = _a.sent();
                    expect(mockNext).toHaveBeenCalledTimes(1);
                    expect(response).toStrictEqual(mockResponse);
                    return [2 /*return*/];
            }
        });
    }); });
    it("returns without logging if context.logger doesn't have info function", function () { return __awaiter(void 0, void 0, void 0, function () {
        var logger, response;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    mockNext.mockResolvedValueOnce(mockResponse);
                    logger = {};
                    return [4 /*yield*/, loggerMiddleware()(mockNext, { logger: logger })(mockArgs)];
                case 1:
                    response = _a.sent();
                    expect(mockNext).toHaveBeenCalledTimes(1);
                    expect(response).toStrictEqual(mockResponse);
                    return [2 /*return*/];
            }
        });
    }); });
    it("logs metadata if context.logger has info function", function () { return __awaiter(void 0, void 0, void 0, function () {
        var logger, context, response;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    mockNext.mockResolvedValueOnce(mockResponse);
                    logger = { info: jest.fn() };
                    context = {
                        logger: logger,
                    };
                    return [4 /*yield*/, loggerMiddleware()(mockNext, context)(mockArgs)];
                case 1:
                    response = _a.sent();
                    expect(mockNext).toHaveBeenCalledTimes(1);
                    expect(response).toStrictEqual(mockResponse);
                    expect(logger.info).toHaveBeenCalledTimes(1);
                    expect(logger.info).toHaveBeenCalledWith({
                        metadata: {
                            statusCode: mockResponse.response.statusCode,
                            requestId: mockResponse.response.headers["x-amzn-requestid"],
                            extendedRequestId: mockResponse.response.headers["x-amz-id-2"],
                            cfId: mockResponse.response.headers["x-amz-cf-id"],
                        },
                    });
                    return [2 /*return*/];
            }
        });
    }); });
    it("logs header x-amzn-request-id as requestId if x-amzn-requestid is not present", function () { return __awaiter(void 0, void 0, void 0, function () {
        var requestIdBackup, customResponse, logger, context, response;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    requestIdBackup = "requestIdBackup";
                    customResponse = __assign(__assign({}, mockResponse), { response: __assign(__assign({}, mockResponse.response), { headers: {
                                "x-amzn-request-id": requestIdBackup,
                            } }) });
                    mockNext.mockResolvedValueOnce(customResponse);
                    logger = { info: jest.fn() };
                    context = {
                        logger: logger,
                    };
                    return [4 /*yield*/, loggerMiddleware()(mockNext, context)(mockArgs)];
                case 1:
                    response = _a.sent();
                    expect(mockNext).toHaveBeenCalledTimes(1);
                    expect(response).toStrictEqual(customResponse);
                    expect(logger.info).toHaveBeenCalledTimes(1);
                    expect(logger.info).toHaveBeenCalledWith({
                        metadata: {
                            statusCode: customResponse.response.statusCode,
                            requestId: requestIdBackup,
                            extendedRequestId: undefined,
                            cfId: undefined,
                        },
                    });
                    return [2 /*return*/];
            }
        });
    }); });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyTWlkZGxld2FyZS5zcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xvZ2dlck1pZGRsZXdhcmUuc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRWhHLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRTtJQUMxQixJQUFNLGVBQWUsR0FBRztRQUN0QixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNmLENBQUM7SUFFRixTQUFTLENBQUM7UUFDUixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsdUJBQXVCLEVBQUU7UUFDMUIsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBRSxlQUF3RCxDQUFDLENBQUM7UUFDNUYsTUFBTSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyRCxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7SUFDaEYsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxrQkFBa0IsRUFBRTtJQUMzQixJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFFM0IsSUFBTSxRQUFRLEdBQUc7UUFDZixLQUFLLEVBQUU7WUFDTCxRQUFRLEVBQUUsWUFBWTtTQUN2QjtRQUNELE9BQU8sRUFBRTtZQUNQLE1BQU0sRUFBRSxLQUFLO1lBQ2IsT0FBTyxFQUFFLEVBQUU7U0FDWjtLQUNGLENBQUM7SUFFRixJQUFNLFlBQVksR0FBRztR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Q3hCLE9BQU8sRUFBRTtnQ0FDUCxtQkFBbUIsRUFBRSxlQUFlOzZCQUNyQyxNQUVKLENBQUM7b0JBQ0YsUUFBUSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQyxDQUFDO29CQUN6QyxNQUFNLEdBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUF3QixDQUFDO29CQUVwRCxPQUFPLEdBQUc7d0JBQ2QsTUFBTSxRQUFBO3FCQUNQLENBQUM7b0JBRWUscUJBQU0sZ0JBQWdCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUE7O29CQUFoRSxRQUFRLEdBQUcsU0FBcUQ7b0JBQ3RFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDMUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQztvQkFFL0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFFN0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQzt3QkFDdkMsUUFBUSxFQUFFOzRCQUNSLFVBQVUsRUFBRSxjQUFjLENBQUMsUUFBUSxDQUFDLFVBQVU7NEJBQzlDLFNBQVMsRUFBRSxlQUFlOzRCQUMxQixpQkFBaUIsRUFBRSxTQUFTOzRCQUM1QixJQUFJLEVBQUUsU0FBUzt5QkFDaEI7cUJBQ0YsQ0FBQyxDQUFDOzs7O1NBQ0osQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2dnZXIsIE1pZGRsZXdhcmVTdGFjayB9IGZyb20gXCJAYXdzLXNkay90eXBlc1wiO1xuXG5pbXBvcnQgeyBnZXRMb2dnZXJQbHVnaW4sIGxvZ2dlck1pZGRsZXdhcmUsIGxvZ2dlck1pZGRsZXdhcmVPcHRpb25zIH0gZnJvbSBcIi4vbG9nZ2VyTWlkZGxld2FyZVwiO1xuXG5kZXNjcmliZShcImdldExvZ2dlclBsdWdpblwiLCAoKSA9PiB7XG4gIGNvbnN0IG1vY2tDbGllbnRTdGFjayA9IHtcbiAgICBhZGQ6IGplc3QuZm4oKSxcbiAgfTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBpdChcImFkZHMgbG9nZ2VyTWlkZGxld2FyZVwiLCAoKSA9PiB7XG4gICAgZ2V0TG9nZ2VyUGx1Z2luKHt9KS5hcHBseVRvU3RhY2soKG1vY2tDbGllbnRTdGFjayBhcyB1bmtub3duKSBhcyBNaWRkbGV3YXJlU3RhY2s8YW55LCBhbnk+KTtcbiAgICBleHBlY3QobW9ja0NsaWVudFN0YWNrLmFkZCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIGV4cGVjdChtb2NrQ2xpZW50U3RhY2suYWRkLm1vY2suY2FsbHNbMF1bMV0pLnRvRXF1YWwobG9nZ2VyTWlkZGxld2FyZU9wdGlvbnMpO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZShcImxvZ2dlck1pZGRsZXdhcmVcIiwgKCkgPT4ge1xuICBjb25zdCBtb2NrTmV4dCA9IGplc3QuZm4oKTtcblxuICBjb25zdCBtb2NrQXJncyA9IHtcbiAgICBpbnB1dDoge1xuICAgICAgaW5wdXRLZXk6IFwiaW5wdXRWYWx1ZVwiLFxuICAgIH0sXG4gICAgcmVxdWVzdDoge1xuICAgICAgbWV0aG9kOiBcIkdFVFwiLFxuICAgICAgaGVhZGVyczoge30sXG4gICAgfSxcbiAgfTtcblxuICBjb25zdCBtb2NrUmVzcG9uc2UgPSB7XG4gICAgcmVzcG9uc2U6IHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJ4LWFtem4tcmVxdWVzdGlkXCI6IFwicmVxdWVzdElkXCIsXG4gICAgICAgIFwieC1hbXotaWQtMlwiOiBcImV4dGVuZGVkUmVxdWVzdElkXCIsXG4gICAgICAgIFwieC1hbXotY2YtaWRcIjogXCJjZklkXCIsXG4gICAgICB9LFxuICAgIH0sXG4gICAgb3V0cHV0OiB7XG4gICAgICBvdXRwdXRLZXk6IFwib3V0cHV0VmFsdWVcIixcbiAgICB9LFxuICB9O1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGl0KFwicmV0dXJucyB3aXRob3V0IGxvZ2dpbmcgaWYgY29udGV4dC5sb2dnZXIgaXMgbm90IGRlZmluZWRcIiwgYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tOZXh0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZShtb2NrUmVzcG9uc2UpO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgbG9nZ2VyTWlkZGxld2FyZSgpKG1vY2tOZXh0LCB7fSkobW9ja0FyZ3MpO1xuICAgIGV4cGVjdChtb2NrTmV4dCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIGV4cGVjdChyZXNwb25zZSkudG9TdHJpY3RFcXVhbChtb2NrUmVzcG9uc2UpO1xuICB9KTtcblxuICBpdChcInJldHVybnMgd2l0aG91dCBsb2dnaW5nIGlmIGNvbnRleHQubG9nZ2VyIGRvZXNuJ3QgaGF2ZSBpbmZvIGZ1bmN0aW9uXCIsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrTmV4dC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UobW9ja1Jlc3BvbnNlKTtcbiAgICBjb25zdCBsb2dnZXIgPSB7fSBhcyBMb2dnZXI7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBsb2dnZXJNaWRkbGV3YXJlKCkobW9ja05leHQsIHsgbG9nZ2VyIH0pKG1vY2tBcmdzKTtcbiAgICBleHBlY3QobW9ja05leHQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QocmVzcG9uc2UpLnRvU3RyaWN0RXF1YWwobW9ja1Jlc3BvbnNlKTtcbiAgfSk7XG5cbiAgaXQoXCJsb2dzIG1ldGFkYXRhIGlmIGNvbnRleHQubG9nZ2VyIGhhcyBpbmZvIGZ1bmN0aW9uXCIsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrTmV4dC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UobW9ja1Jlc3BvbnNlKTtcbiAgICBjb25zdCBsb2dnZXIgPSAoeyBpbmZvOiBqZXN0LmZuKCkgfSBhcyB1bmtub3duKSBhcyBMb2dnZXI7XG5cbiAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgbG9nZ2VyLFxuICAgIH07XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGxvZ2dlck1pZGRsZXdhcmUoKShtb2NrTmV4dCwgY29udGV4dCkobW9ja0FyZ3MpO1xuICAgIGV4cGVjdChtb2NrTmV4dCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIGV4cGVjdChyZXNwb25zZSkudG9TdHJpY3RFcXVhbChtb2NrUmVzcG9uc2UpO1xuXG4gICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG5cbiAgICBleHBlY3QobG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IG1vY2tSZXNwb25zZS5yZXNwb25zZS5zdGF0dXNDb2RlLFxuICAgICAgICByZXF1ZXN0SWQ6IG1vY2tSZXNwb25zZS5yZXNwb25zZS5oZWFkZXJzW1wieC1hbXpuLXJlcXVlc3RpZFwiXSxcbiAgICAgICAgZXh0ZW5kZWRSZXF1ZXN0SWQ6IG1vY2tSZXNwb25zZS5yZXNwb25zZS5oZWFkZXJzW1wieC1hbXotaWQtMlwiXSxcbiAgICAgICAgY2ZJZDogbW9ja1Jlc3BvbnNlLnJlc3BvbnNlLmhlYWRlcnNbXCJ4LWFtei1jZi1pZFwiXSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KFwibG9ncyBoZWFkZXIgeC1hbXpuLXJlcXVlc3QtaWQgYXMgcmVxdWVzdElkIGlmIHgtYW16bi1yZXF1ZXN0aWQgaXMgbm90IHByZXNlbnRcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3RJZEJhY2t1cCA9IFwicmVxdWVzdElkQmFja3VwXCI7XG4gICAgY29uc3QgY3VzdG9tUmVzcG9uc2UgPSB7XG4gICAgICAuLi5tb2NrUmVzcG9uc2UsXG4gICAgICByZXNwb25zZToge1xuICAgICAgICAuLi5tb2NrUmVzcG9uc2UucmVzcG9uc2UsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICBcIngtYW16bi1yZXF1ZXN0LWlkXCI6IHJlcXVlc3RJZEJhY2t1cCxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcbiAgICBtb2NrTmV4dC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoY3VzdG9tUmVzcG9uc2UpO1xuICAgIGNvbnN0IGxvZ2dlciA9ICh7IGluZm86IGplc3QuZm4oKSB9IGFzIHVua25vd24pIGFzIExvZ2dlcjtcblxuICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICBsb2dnZXIsXG4gICAgfTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgbG9nZ2VyTWlkZGxld2FyZSgpKG1vY2tOZXh0LCBjb250ZXh0KShtb2NrQXJncyk7XG4gICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgZXhwZWN0KHJlc3BvbnNlKS50b1N0cmljdEVxdWFsKGN1c3RvbVJlc3BvbnNlKTtcblxuICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuXG4gICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICBtZXRhZGF0YToge1xuICAgICAgICBzdGF0dXNDb2RlOiBjdXN0b21SZXNwb25zZS5yZXNwb25zZS5zdGF0dXNDb2RlLFxuICAgICAgICByZXF1ZXN0SWQ6IHJlcXVlc3RJZEJhY2t1cCxcbiAgICAgICAgZXh0ZW5kZWRSZXF1ZXN0SWQ6IHVuZGVmaW5lZCxcbiAgICAgICAgY2ZJZDogdW5kZWZpbmVkLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==