"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateNoFIPS = exports.validateNoDualstack = exports.getArnResources = exports.validateDNSHostLabel = exports.validateAccountId = exports.validateRegion = exports.validatePartition = exports.validateOutpostService = exports.validateS3Service = exports.validateService = exports.validateArnEndpointOptions = exports.getSuffixForArnEndpoint = exports.getSuffix = exports.isDnsCompatibleBucketName = exports.getPseudoRegion = exports.isBucketNameOptions = exports.S3_HOSTNAME_PATTERN = exports.DOT_PATTERN = void 0;
const DOMAIN_PATTERN = /^[a-z0-9][a-z0-9\.\-]{1,61}[a-z0-9]$/;
const IP_ADDRESS_PATTERN = /(\d+\.){3}\d+/;
const DOTS_PATTERN = /\.\./;
exports.DOT_PATTERN = /\./;
exports.S3_HOSTNAME_PATTERN = /^(.+\.)?s3[.-]([a-z0-9-]+)\./;
const S3_US_EAST_1_ALTNAME_PATTERN = /^s3(-external-1)?\.amazonaws\.com$/;
const AWS_PARTITION_SUFFIX = "amazonaws.com";
exports.isBucketNameOptions = (options) => typeof options.bucketName === "string";
/**
 * Get pseudo region from supplied region. For example, if supplied with `fips-us-west-2`, it returns `us-west-2`.
 * @internal
 */
exports.getPseudoRegion = (region) => (isFipsRegion(region) ? region.replace(/fips-|-fips/, "") : region);
/**
 * Determines whether a given string is DNS compliant per the rules outlined by
 * S3. Length, capitaization, and leading dot restrictions are enforced by the
 * DOMAIN_PATTERN regular expression.
 * @internal
 *
 * @see https://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html
 */
exports.isDnsCompatibleBucketName = (bucketName) => DOMAIN_PATTERN.test(bucketName) && !IP_ADDRESS_PATTERN.test(bucketName) && !DOTS_PATTERN.test(bucketName);
const getRegionalSuffix = (hostname) => {
    const parts = hostname.match(exports.S3_HOSTNAME_PATTERN);
    return [parts[2], hostname.replace(new RegExp(`^${parts[0]}`), "")];
};
exports.getSuffix = (hostname) => S3_US_EAST_1_ALTNAME_PATTERN.test(hostname) ? ["us-east-1", AWS_PARTITION_SUFFIX] : getRegionalSuffix(hostname);
/**
 * Infer region and hostname suffix from a complete hostname
 * @internal
 * @param hostname - Hostname
 * @returns [Region, Hostname suffix]
 */
exports.getSuffixForArnEndpoint = (hostname) => S3_US_EAST_1_ALTNAME_PATTERN.test(hostname)
    ? [hostname.replace(`.${AWS_PARTITION_SUFFIX}`, ""), AWS_PARTITION_SUFFIX]
    : getRegionalSuffix(hostname);
exports.validateArnEndpointOptions = (options) => {
    if (options.pathStyleEndpoint) {
        throw new Error("Path-style S3 endpoint is not supported when bucket is an ARN");
    }
    if (options.accelerateEndpoint) {
        throw new Error("Accelerate endpoint is not supported when bucket is an ARN");
    }
    if (!options.tlsCompatible) {
        throw new Error("HTTPS is required when bucket is an ARN");
    }
};
exports.validateService = (service) => {
    if (service !== "s3" && service !== "s3-outposts") {
        throw new Error("Expect 's3' or 's3-outposts' in ARN service component");
    }
};
exports.validateS3Service = (service) => {
    if (service !== "s3") {
        throw new Error("Expect 's3' in Accesspoint ARN service component");
    }
};
exports.validateOutpostService = (service) => {
    if (service !== "s3-outposts") {
        throw new Error("Expect 's3-posts' in Outpost ARN service component");
    }
};
/**
 * Validate partition inferred from ARN is the same to `options.clientPartition`.
 * @internal
 */
exports.validatePartition = (partition, options) => {
    if (partition !== options.clientPartition) {
        throw new Error(`Partition in ARN is incompatible, got "${partition}" but expected "${options.clientPartition}"`);
    }
};
/**
 * validate region value inferred from ARN. If `options.useArnRegion` is set, it validates the region is not a FIPS
 * region. If `options.useArnRegion` is unset, it validates the region is equal to `options.clientRegion` or
 * `options.clientSigningRegion`.
 * @internal
 */
exports.validateRegion = (region, options) => {
    if (region === "") {
        throw new Error("ARN region is empty");
    }
    if (!options.useArnRegion &&
        !isEqualRegions(region, options.clientRegion) &&
        !isEqualRegions(region, options.clientSigningRegion)) {
        throw new Error(`Region in ARN is incompatible, got ${region} but expected ${options.clientRegion}`);
    }
    if (options.useArnRegion && isFipsRegion(region)) {
        throw new Error("Endpoint does not support FIPS region");
    }
};
const isFipsRegion = (region) => region.startsWith("fips-") || region.endsWith("-fips");
const isEqualRegions = (regionA, regionB) => regionA === regionB || exports.getPseudoRegion(regionA) === regionB || regionA === exports.getPseudoRegion(regionB);
/**
 * Validate an account ID
 * @internal
 */
exports.validateAccountId = (accountId) => {
    if (!/[0-9]{12}/.exec(accountId)) {
        throw new Error("Access point ARN accountID does not match regex '[0-9]{12}'");
    }
};
/**
 * Validate a host label according to https://tools.ietf.org/html/rfc3986#section-3.2.2
 * @internal
 */
exports.validateDNSHostLabel = (label, options = { tlsCompatible: true }) => {
    // reference: https://tools.ietf.org/html/rfc3986#section-3.2.2
    if (label.length >= 64 ||
        !/^[a-z0-9][a-z0-9.-]+[a-z0-9]$/.test(label) ||
        /(\d+\.){3}\d+/.test(label) ||
        /[.-]{2}/.test(label) ||
        ((options === null || options === void 0 ? void 0 : options.tlsCompatible) && exports.DOT_PATTERN.test(label))) {
        throw new Error(`Invalid DNS label ${label}`);
    }
};
/**
 * Validate and parse an Access Point ARN or Outposts ARN
 * @internal
 *
 * @param resource - The resource section of an ARN
 * @returns Access Point Name and optional Outpost ID.
 */
exports.getArnResources = (resource) => {
    const delimiter = resource.includes(":") ? ":" : "/";
    const [resourceType, ...rest] = resource.split(delimiter);
    if (resourceType === "accesspoint") {
        // Parse accesspoint ARN
        if (rest.length !== 1 || rest[0] === "") {
            throw new Error(`Access Point ARN should have one resource accesspoint${delimiter}{accesspointname}`);
        }
        return { accesspointName: rest[0] };
    }
    else if (resourceType === "outpost") {
        // Parse outpost ARN
        if (!rest[0] || rest[1] !== "accesspoint" || !rest[2] || rest.length !== 3) {
            throw new Error(`Outpost ARN should have resource outpost${delimiter}{outpostId}${delimiter}accesspoint${delimiter}{accesspointName}`);
        }
        const [outpostId, _, accesspointName] = rest;
        return { outpostId, accesspointName };
    }
    else {
        throw new Error(`ARN resource should begin with 'accesspoint${delimiter}' or 'outpost${delimiter}'`);
    }
};
/**
 * Throw if dual stack configuration is set to true.
 * @internal
 */
exports.validateNoDualstack = (dualstackEndpoint) => {
    if (dualstackEndpoint)
        throw new Error("Dualstack endpoint is not supported with Outpost");
};
/**
 * Validate region is not appended or prepended with a `fips-`
 * @internal
 */
exports.validateNoFIPS = (region) => {
    if (isFipsRegion(region !== null && region !== void 0 ? region : ""))
        throw new Error(`FIPS region is not supported with Outpost, got ${region}`);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0SG9zdG5hbWVVdGlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWNrZXRIb3N0bmFtZVV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLE1BQU0sY0FBYyxHQUFHLHNDQUFzQyxDQUFDO0FBQzlELE1BQU0sa0JBQWtCLEdBQUcsZUFBZSxDQUFDO0FBQzNDLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQztBQUNmLFFBQUEsV0FBVyxHQUFHLElBQUksQ0FBQztBQUNuQixRQUFBLG1CQUFtQixHQUFHLDhCQUE4QixDQUFDO0FBQ2xFLE1BQU0sNEJBQTRCLEdBQUcsb0NBQW9DLENBQUM7QUFDMUUsTUFBTSxvQkFBb0IsR0FBRyxlQUFlLENBQUM7QUFzQmhDLFFBQUEsbUJBQW1CLEdBQUcsQ0FDakMsT0FBaUQsRUFDaEIsRUFBRSxDQUFDLE9BQU8sT0FBTyxDQUFDLFVBQVUsS0FBSyxRQUFRLENBQUM7QUFFN0U7OztHQUdHO0FBQ1UsUUFBQSxlQUFlLEdBQUcsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7QUFFdkg7Ozs7Ozs7R0FPRztBQUNVLFFBQUEseUJBQXlCLEdBQUcsQ0FBQyxVQUFrQixFQUFXLEVBQUUsQ0FDdkUsY0FBYyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFNUcsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLFFBQWdCLEVBQW9CLEVBQUU7SUFDL0QsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQywyQkFBbUIsQ0FBRSxD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RSxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDN0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsQ0FBQztLQUN2QztTQUFNO1FBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw4Q0FBOEMsU0FBUyxnQkFBZ0IsU0FBUyxHQUFHLENBQUMsQ0FBQztLQUN0RztBQUNILENBQUMsQ0FBQztBQUVGOzs7R0FHRztBQUNVLFFBQUEsbUJBQW1CLEdBQUcsQ0FBQyxpQkFBMEIsRUFBRSxFQUFFO0lBQ2hFLElBQUksaUJBQWlCO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO0FBQzdGLENBQUMsQ0FBQztBQUVGOzs7R0FHRztBQUNVLFFBQUEsY0FBYyxHQUFHLENBQUMsTUFBYyxFQUFFLEVBQUU7SUFDL0MsSUFBSSxZQUFZLENBQUMsTUFBTSxhQUFOLE1BQU0sY0FBTixNQUFNLEdBQUksRUFBRSxDQUFDO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxrREFBa0QsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUM5RyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUk4gfSBmcm9tIFwiQGF3cy1zZGsvdXRpbC1hcm4tcGFyc2VyXCI7XG5cbmNvbnN0IERPTUFJTl9QQVRURVJOID0gL15bYS16MC05XVthLXowLTlcXC5cXC1dezEsNjF9W2EtejAtOV0kLztcbmNvbnN0IElQX0FERFJFU1NfUEFUVEVSTiA9IC8oXFxkK1xcLil7M31cXGQrLztcbmNvbnN0IERPVFNfUEFUVEVSTiA9IC9cXC5cXC4vO1xuZXhwb3J0IGNvbnN0IERPVF9QQVRURVJOID0gL1xcLi87XG5leHBvcnQgY29uc3QgUzNfSE9TVE5BTUVfUEFUVEVSTiA9IC9eKC4rXFwuKT9zM1suLV0oW2EtejAtOS1dKylcXC4vO1xuY29uc3QgUzNfVVNfRUFTVF8xX0FMVE5BTUVfUEFUVEVSTiA9IC9eczMoLWV4dGVybmFsLTEpP1xcLmFtYXpvbmF3c1xcLmNvbSQvO1xuY29uc3QgQVdTX1BBUlRJVElPTl9TVUZGSVggPSBcImFtYXpvbmF3cy5jb21cIjtcblxuZXhwb3J0IGludGVyZmFjZSBBY2Nlc3NQb2ludEFybiBleHRlbmRzIEFSTiB7XG4gIGFjY2Vzc1BvaW50TmFtZTogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJ1Y2tldEhvc3RuYW1lUGFyYW1zIHtcbiAgYmFzZUhvc3RuYW1lOiBzdHJpbmc7XG4gIGJ1Y2tldE5hbWU6IHN0cmluZztcbiAgYWNjZWxlcmF0ZUVuZHBvaW50PzogYm9vbGVhbjtcbiAgZHVhbHN0YWNrRW5kcG9pbnQ/OiBib29sZWFuO1xuICBwYXRoU3R5bGVFbmRwb2ludD86IGJvb2xlYW47XG4gIHRsc0NvbXBhdGlibGU/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFybkhvc3RuYW1lUGFyYW1zIGV4dGVuZHMgT21pdDxCdWNrZXRIb3N0bmFtZVBhcmFtcywgXCJidWNrZXROYW1lXCI+IHtcbiAgYnVja2V0TmFtZTogQVJOO1xuICBjbGllbnRTaWduaW5nUmVnaW9uPzogc3RyaW5nO1xuICBjbGllbnRQYXJ0aXRpb24/OiBzdHJpbmc7XG4gIHVzZUFyblJlZ2lvbj86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjb25zdCBpc0J1Y2tldE5hbWVPcHRpb25zID0gKFxuICBvcHRpb25zOiBCdWNrZXRIb3N0bmFtZVBhcmFtcyB8IEFybkhvc3RuYW1lUGFyYW1zXG4pOiBvcHRpb25zIGlzIEJ1Y2tldEhvc3RuYW1lUGFyYW1zID0+IHR5cGVvZiBvcHRpb25zLmJ1Y2tldE5hbWUgPT09IFwic3RyaW5nXCI7XG5cbi8qKlxuICogR2V0IHBzZXVkbyByZWdpb24gZnJvbSBzdXBwbGllZCByZWdpb24uIEZvciBleGFtcGxlLCBpZiBzdXBwbGllZCB3aXRoIGBmaXBzLXVzLXdlc3QtMmAsIGl0IHJldHVybnMgYHVzLXdlc3QtMmAuXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNvbnN0IGdldFBzZXVkb1JlZ2lvbiA9IChyZWdpb246IHN0cmluZykgPT4gKGlzRmlwc1JlZ2lvbihyZWdpb24pID8gcmVnaW9uLnJlcGxhY2UoL2ZpcHMtfC1maXBzLywgXCJcIikgOiByZWdpb24pO1xuXG4vKipcbiAqIERldGVybWluZXMgd2hldGhlciBhIGdpdmVuIHN0cmluZyBpcyBETlMgY29tcGxpYW50IHBlciB0aGUgcnVsZXMgb3V0bGluZWQgYnlcbiAqIFMzLiBMZW5ndGgsIGNhcGl0YWl6YXRpb24sIGFuZCBsZWFkaW5nIGRvdCByZXN0cmljdGlvbnMgYXJlIGVuZm9yY2VkIGJ5IHRoZVxuICogRE9NQUlOX1BBVFRFUk4gcmVndWxhciBleHByZXNzaW9uLlxuICogQGludGVybmFsXG4gKlxuICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uUzMvbGF0ZXN0L2Rldi9CdWNrZXRSZXN0cmljdGlvbnMuaHRtbFxuICovXG5leHBvcnQgY29uc3QgaXNEbnNDb21wYXRpYmxlQnVja2V0TmFtZSA9IChidWNrZXROYW1lOiBzdHJpbmcpOiBib29sZWFuID0+XG4gIERPTUFJTl9QQVRURVJOLnRlc3QoYnVja2V0TmFtZSkgJiYgIUlQX0FERFJFU1NfUEFUVEVSTi50ZXN0KGJ1Y2tldE5hbWUpICYmICFET1RTX1BBVFRFUk4udGVzdChidWNrZXROYW1lKTtcblxuY29uc3QgZ2V0UmVnaW9uYWxTdWZmaXggPSAoaG9zdG5hbWU6IHN0cmluZyk6IFtzdHJpbmcsIHN0cmluZ10gPT4ge1xuICBjb25zdCBwYXJ0cyA9IGhvc3RuYW1lLm1hdGNoKFMzX0hPU1ROQU1FX1BBVFRFUk4pITtcbiAgcmV0dXJuIFtwYXJ0c1syXSwgaG9zdG5hbWUucmVwbGFjZShuZXcgUmVnRXhwKGBeJHtwYXJ0c1swXX1gKSwgXCJcIildO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldFN1ZmZpeCA9IChob3N0bmFtZTogc3RyaW5nKTogW3N0cmluZywgc3RyaW5nXSA9PlxuICBTM19VU19FQVNUXzFfQUxUTkFNRV9QQVRURVJOLnRlc3QoaG9zdG5hbWUpID8gW1widXMtZWFzdC0xXCIsIEFXU19QQVJUSVRJT05fU1VGRklYXSA6IGdldFJlZ2lvbmFsU3VmZml4KGhvc3RuYW1lKTtcblxuLyoqXG4gKiBJbmZlciByZWdpb24gYW5kIGhvc3RuYW1lIHN1ZmZpeCBmcm9tIGEgY29tcGxldGUgaG9zdG5hbWVcbiAqIEBpbnRlcm5hbFxuICogQHBhcmFtIGhvc3RuYW1lIC0gSG9zdG5hbWVcbiAqIEByZXR1cm5zIFtSZWdpb24sIEhvc3RuYW1lIHN1ZmZpeF1cbiAqL1xuZXhwb3J0IGNvbnN0IGdldFN1ZmZpeEZvckFybkVuZHBvaW50ID0gKGhvc3RuYW1lOiBzdHJpbmcpOiBbc3RyaW5nLCBzdHJpbmddID0+XG4gIFMzX1VTX0VBU1RfMV9BTFROQU1FX1BBVFRFUk4udGVzdChob3N0bmFtZSlcbiAgICA/IFtob3N0bmFtZS5yZXBsYWNlKGAuJHtBV1NfUEFSVElUSU9OX1NVRkZJWH1gLCBcIlwiKSwgQVdTX1BBUlRJVElPTl9TVUZGSVhdXG4gICAgOiBnZXRSZWdpb25hbFN1ZmZpeChob3N0bmFtZSk7XG5cbmV4cG9ydCBjb25zdCB2YWxpZGF0ZUFybkVuZHBvaW50T3B0aW9ucyA9IChvcHRpb25zOiB7XG4gIGFjY2VsZXJhdGVFbmRwb2ludD86IGJvb2xlYW47XG4gIHRsc0NvbXBhdGlibGU/OiBib29sZWFuO1xuICBwYXRoU3R5bGVFbmRwb2ludD86IGJvb2xlYW47XG59KSA9PiB7XG4gIGlmIChvcHRpb25zLnBhdGhTdHlsZUVuZHBvaW50KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUGF0aC1zdHlsZSBTMyBlbmRwb2ludCBpcyBub3Qgc3VwcG9ydGVkIHdoZW4gYnVja2V0IGlzIGFuIEFSTlwiKTtcbiAgfVxuICBpZiAob3B0aW9ucy5hY2NlbGVyYXRlRW5kcG9pbnQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJBY2NlbGVyYXRlIGVuZHBvaW50IGlzIG5vdCBzdXBwb3J0ZWQgd2hlbiBidWNrZXQgaXMgYW4gQVJOXCIpO1xuICB9XG4gIGlmICghb3B0aW9ucy50bHNDb21wYXRpYmxlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiSFRUUFMgaXMgcmVxdWlyZWQgd2hlbiBidWNrZXQgaXMgYW4gQVJOXCIpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgdmFsaWRhdGVTZXJ2aWNlID0gKHNlcnZpY2U6IHN0cmluZykgPT4ge1xuICBpZiAoc2VydmljZSAhPT0gXCJzM1wiICYmIHNlcnZpY2UgIT09IFwiczMtb3V0cG9zdHNcIikge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkV4cGVjdCAnczMnIG9yICdzMy1vdXRwb3N0cycgaW4gQVJOIHNlcnZpY2UgY29tcG9uZW50XCIpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgdmFsaWRhdGVTM1NlcnZpY2UgPSAoc2VydmljZTogc3RyaW5nKSA9PiB7XG4gIGlmIChzZXJ2aWNlICE9PSBcInMzXCIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJFeHBlY3QgJ3MzJyBpbiBBY2Nlc3Nwb2ludCBBUk4gc2VydmljZSBjb21wb25lbnRcIik7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCB2YWxpZGF0ZU91dHBvc3RTZXJ2aWNlID0gKHNlcnZpY2U6IHN0cmluZykgPT4ge1xuICBpZiAoc2VydmljZSAhPT0gXCJzMy1vdXRwb3N0c1wiKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRXhwZWN0ICdzMy1wb3N0cycgaW4gT3V0cG9zdCBBUk4gc2VydmljZSBjb21wb25lbnRcIik7XG4gIH1cbn07XG5cbi8qKlxuICogVmFsaWRhdGUgcGFydGl0aW9uIGluZmVycmVkIGZyb20gQVJOIGlzIHRoZSBzYW1lIHRvIGBvcHRpb25zLmNsaWVudFBhcnRpdGlvbmAuXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNvbnN0IHZhbGlkYXRlUGFydGl0aW9uID0gKHBhcnRpdGlvbjogc3RyaW5nLCBvcHRpb25zOiB7IGNsaWVudFBhcnRpdGlvbjogc3RyaW5nIH0pID0+IHtcbiAgaWYgKHBhcnRpdGlvbiAhPT0gb3B0aW9ucy5jbGllbnRQYXJ0aXRpb24pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFBhcnRpdGlvbiBpbiBBUk4gaXMgaW5jb21wYXRpYmxlLCBnb3QgXCIke3BhcnRpdGlvbn1cIiBidXQgZXhwZWN0ZWQgXCIke29wdGlvbnMuY2xpZW50UGFydGl0aW9ufVwiYCk7XG4gIH1cbn07XG5cbi8qKlxuICogdmFsaWRhdGUgcmVnaW9uIHZhbHVlIGluZmVycmVkIGZyb20gQVJOLiBJZiBgb3B0aW9ucy51c2VBcm5SZWdpb25gIGlzIHNldCwgaXQgdmFsaWRhdGVzIHRoZSByZWdpb24gaXMgbm90IGEgRklQU1xuICogcmVnaW9uLiBJZiBgb3B0aW9ucy51c2VBcm5SZWdpb25gIGlzIHVuc2V0LCBpdCB2YWxpZGF0ZXMgdGhlIHJlZ2lvbiBpcyBlcXVhbCB0byBgb3B0aW9ucy5jbGllbnRSZWdpb25gIG9yXG4gKiBgb3B0aW9ucy5jbGllbnRTaWduaW5nUmVnaW9uYC5cbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgY29uc3QgdmFsaWRhdGVSZWdpb24gPSAoXG4gIHJlZ2lvbjogc3RyaW5nLFxuICBvcHRpb25zOiB7XG4gICAgdXNlQXJuUmVnaW9uPzogYm9vbGVhbjtcbiAgICBjbGllbnRSZWdpb246IHN0cmluZztcbiAgICBjbGllbnRTaWduaW5nUmVnaW9uOiBzdHJpbmc7XG4gIH1cbikgPT4ge1xuICBpZiAocmVnaW9uID09PSBcIlwiKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQVJOIHJlZ2lvbiBpcyBlbXB0eVwiKTtcbiAgfVxuICBpZiAoXG4gICAgIW9wdGlvbnMudXNlQXJuUmVnaW9uICYmXG4gICAgIWlzRXF1YWxSZWdpb25zKHJlZ2lvbiwgb3B0aW9ucy5jbGllbnRSZWdpb24pICYmXG4gICAgIWlzRXF1YWxSZWdpb25zKHJlZ2lvbiwgb3B0aW9ucy5jbGllbnRTaWduaW5nUmVnaW9uKVxuICApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZ2lvbiBpbiBBUk4gaXMgaW5jb21wYXRpYmxlLCBnb3QgJHtyZWdpb259IGJ1dCBleHBlY3RlZCAke29wdGlvbnMuY2xpZW50UmVnaW9ufWApO1xuICB9XG4gIGlmIChvcHRpb25zLnVzZUFyblJlZ2lvbiAmJiBpc0ZpcHNSZWdpb24ocmVnaW9uKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkVuZHBvaW50IGRvZXMgbm90IHN1cHBvcnQgRklQUyByZWdpb25cIik7XG4gIH1cbn07XG5cbmNvbnN0IGlzRmlwc1JlZ2lvbiA9IChyZWdpb246IHN0cmluZykgPT4gcmVnaW9uLnN0YXJ0c1dpdGgoXCJmaXBzLVwiKSB8fCByZWdpb24uZW5kc1dpdGgoXCItZmlwc1wiKTtcblxuY29uc3QgaXNFcXVhbFJlZ2lvbnMgPSAocmVnaW9uQTogc3RyaW5nLCByZWdpb25COiBzdHJpbmcpID0+XG4gIHJlZ2lvbkEgPT09IHJlZ2lvbkIgfHwgZ2V0UHNldWRvUmVnaW9uKHJlZ2lvbkEpID09PSByZWdpb25CIHx8IHJlZ2lvbkEgPT09IGdldFBzZXVkb1JlZ2lvbihyZWdpb25CKTtcblxuLyoqXG4gKiBWYWxpZGF0ZSBhbiBhY2NvdW50IElEXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNvbnN0IHZhbGlkYXRlQWNjb3VudElkID0gKGFjY291bnRJZDogc3RyaW5nKSA9PiB7XG4gIGlmICghL1swLTldezEyfS8uZXhlYyhhY2NvdW50SWQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQWNjZXNzIHBvaW50IEFSTiBhY2NvdW50SUQgZG9lcyBub3QgbWF0Y2ggcmVnZXggJ1swLTldezEyfSdcIik7XG4gIH1cbn07XG5cbi8qKlxuICogVmFsaWRhdGUgYSBob3N0IGxhYmVsIGFjY29yZGluZyB0byBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NiNzZWN0aW9uLTMuMi4yXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNvbnN0IHZhbGlkYXRlRE5TSG9zdExhYmVsID0gKGxhYmVsOiBzdHJpbmcsIG9wdGlvbnM6IHsgdGxzQ29tcGF0aWJsZT86IGJvb2xlYW4gfSA9IHsgdGxzQ29tcGF0aWJsZTogdHJ1ZSB9KSA9PiB7XG4gIC8vIHJlZmVyZW5jZTogaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODYjc2VjdGlvbi0zLjIuMlxuICBpZiAoXG4gICAgbGFiZWwubGVuZ3RoID49IDY0IHx8XG4gICAgIS9eW2EtejAtOV1bYS16MC05Li1dK1thLXowLTldJC8udGVzdChsYWJlbCkgfHxcbiAgICAvKFxcZCtcXC4pezN9XFxkKy8udGVzdChsYWJlbCkgfHxcbiAgICAvWy4tXXsyfS8udGVzdChsYWJlbCkgfHxcbiAgICAob3B0aW9ucz8udGxzQ29tcGF0aWJsZSAmJiBET1RfUEFUVEVSTi50ZXN0KGxhYmVsKSlcbiAgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIEROUyBsYWJlbCAke2xhYmVsfWApO1xuICB9XG59O1xuXG4vKipcbiAqIFZhbGlkYXRlIGFuZCBwYXJzZSBhbiBBY2Nlc3MgUG9pbnQgQVJOIG9yIE91dHBvc3RzIEFSTlxuICogQGludGVybmFsXG4gKlxuICogQHBhcmFtIHJlc291cmNlIC0gVGhlIHJlc291cmNlIHNlY3Rpb24gb2YgYW4gQVJOXG4gKiBAcmV0dXJucyBBY2Nlc3MgUG9pbnQgTmFtZSBhbmQgb3B0aW9uYWwgT3V0cG9zdCBJRC5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldEFyblJlc291cmNlcyA9IChcbiAgcmVzb3VyY2U6IHN0cmluZ1xuKToge1xuICBhY2Nlc3Nwb2ludE5hbWU6IHN0cmluZztcbiAgb3V0cG9zdElkPzogc3RyaW5nO1xufSA9PiB7XG4gIGNvbnN0IGRlbGltaXRlciA9IHJlc291cmNlLmluY2x1ZGVzKFwiOlwiKSA/IFwiOlwiIDogXCIvXCI7XG4gIGNvbnN0IFtyZXNvdXJjZVR5cGUsIC4uLnJlc3RdID0gcmVzb3VyY2Uuc3BsaXQoZGVsaW1pdGVyKTtcbiAgaWYgKHJlc291cmNlVHlwZSA9PT0gXCJhY2Nlc3Nwb2ludFwiKSB7XG4gICAgLy8gUGFyc2UgYWNjZXNzcG9pbnQgQVJOXG4gICAgaWYgKHJlc3QubGVuZ3RoICE9PSAxIHx8IHJlc3RbMF0gPT09IFwiXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQWNjZXNzIFBvaW50IEFSTiBzaG91bGQgaGF2ZSBvbmUgcmVzb3VyY2UgYWNjZXNzcG9pbnQke2RlbGltaXRlcn17YWNjZXNzcG9pbnRuYW1lfWApO1xuICAgIH1cbiAgICByZXR1cm4geyBhY2Nlc3Nwb2ludE5hbWU6IHJlc3RbMF0gfTtcbiAgfSBlbHNlIGlmIChyZXNvdXJjZVR5cGUgPT09IFwib3V0cG9zdFwiKSB7XG4gICAgLy8gUGFyc2Ugb3V0cG9zdCBBUk5cbiAgICBpZiAoIXJlc3RbMF0gfHwgcmVzdFsxXSAhPT0gXCJhY2Nlc3Nwb2ludFwiIHx8ICFyZXN0WzJdIHx8IHJlc3QubGVuZ3RoICE9PSAzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBPdXRwb3N0IEFSTiBzaG91bGQgaGF2ZSByZXNvdXJjZSBvdXRwb3N0JHtkZWxpbWl0ZXJ9e291dHBvc3RJZH0ke2RlbGltaXRlcn1hY2Nlc3Nwb2ludCR7ZGVsaW1pdGVyfXthY2Nlc3Nwb2ludE5hbWV9YFxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgW291dHBvc3RJZCwgXywgYWNjZXNzcG9pbnROYW1lXSA9IHJlc3Q7XG4gICAgcmV0dXJuIHsgb3V0cG9zdElkLCBhY2Nlc3Nwb2ludE5hbWUgfTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEFSTiByZXNvdXJjZSBzaG91bGQgYmVnaW4gd2l0aCAnYWNjZXNzcG9pbnQke2RlbGltaXRlcn0nIG9yICdvdXRwb3N0JHtkZWxpbWl0ZXJ9J2ApO1xuICB9XG59O1xuXG4vKipcbiAqIFRocm93IGlmIGR1YWwgc3RhY2sgY29uZmlndXJhdGlvbiBpcyBzZXQgdG8gdHJ1ZS5cbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgY29uc3QgdmFsaWRhdGVOb0R1YWxzdGFjayA9IChkdWFsc3RhY2tFbmRwb2ludDogYm9vbGVhbikgPT4ge1xuICBpZiAoZHVhbHN0YWNrRW5kcG9pbnQpIHRocm93IG5ldyBFcnJvcihcIkR1YWxzdGFjayBlbmRwb2ludCBpcyBub3Qgc3VwcG9ydGVkIHdpdGggT3V0cG9zdFwiKTtcbn07XG5cbi8qKlxuICogVmFsaWRhdGUgcmVnaW9uIGlzIG5vdCBhcHBlbmRlZCBvciBwcmVwZW5kZWQgd2l0aCBhIGBmaXBzLWBcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgY29uc3QgdmFsaWRhdGVOb0ZJUFMgPSAocmVnaW9uOiBzdHJpbmcpID0+IHtcbiAgaWYgKGlzRmlwc1JlZ2lvbihyZWdpb24gPz8gXCJcIikpIHRocm93IG5ldyBFcnJvcihgRklQUyByZWdpb24gaXMgbm90IHN1cHBvcnRlZCB3aXRoIE91dHBvc3QsIGdvdCAke3JlZ2lvbn1gKTtcbn07XG4iXX0=